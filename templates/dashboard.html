<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Risk Portfolio Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
</head>
<body>
    <div class="container">
        <!-- Status Bar -->
        <div id="status-bar" class="status-bar">
            <span id="status-text"></span>
            <span id="status-spinner" class="spinner" style="display: none;">‚è≥</span>
        </div>
        
        <header>
            <h1>üìä Risk Portfolio Dashboard</h1>
            <div class="header-actions">
                <button id="btn-evaluate" class="btn btn-primary">Run Evaluation</button>
                <button id="btn-refresh" class="btn btn-secondary">Refresh</button>
            </div>
        </header>

        <div class="dashboard-grid">
            <!-- Risk Summary Card -->
            <div class="card risk-summary">
                <h2>Risk Summary</h2>
                <div class="risk-score">
                    <span class="score-value" id="risk-score">{{ risk_score }}</span>
                    <span class="score-label">Risk-off Score: {{ risk_level }}</span>
                </div>
                <p class="muted">
                    This is a <strong>risk-off / de-risking</strong> indicator (0 = calm/low signals, 100 = crisis/high signals),
                    based on macro + sector + stock stress signals and drawdowns. It is <strong>not</strong> a ‚Äúshould I buy?‚Äù score.
                </p>
                {% if risk_worst_position_pnl_pct is not none %}
                <p class="muted">
                    Worst holding P&L: <strong>{{ "%.2f"|format(risk_worst_position_pnl_pct) }}%</strong>
                </p>
                {% endif %}
                {% if risk_missing_market_inputs %}
                <p class="muted">
                    Data missing (lower confidence): {{ risk_missing_market_inputs|join(", ") }}
                </p>
                {% endif %}
                <div class="risk-actions">
                    {% if latest_report %}
                    <a href="/reports/{{ latest_report.html_path }}" target="_blank" class="btn btn-small">View Full Report</a>
                    {% else %}
                    <span class="muted">No report yet ‚Äî run an evaluation.</span>
                    {% endif %}
                </div>
            </div>

            <!-- Portfolio Holdings -->
            <div class="card portfolio-holdings">
                <div class="card-header">
                    <h2>Portfolio Holdings</h2>
                    <button id="btn-add-holding" class="btn btn-small btn-primary">+ Add Holding</button>
                </div>
                <div class="table-container">
                    <table id="holdings-table">
                        <thead>
                            <tr>
                                <th>Ticker</th>
                                <th>Symbol</th>
                                <th>Shares</th>
                                <th>Baseline Value (¬£)</th>
                                <th>Current Value (¬£)</th>
                                <th>P&L (¬£)</th>
                                <th>P&L (%)</th>
                                <th>Action</th>
                                <th>Risk Bucket</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="holdings-tbody">
                            {% for ticker, holding in portfolio.holdings.items() %}
                            {% set pos = portfolio_pnl.positions_by_ticker.get(ticker, {}) %}
                            {% set current_value = pos.get("current_value_gbp") %}
                            {% set change_gbp = pos.get("change_gbp", 0) %}
                            {% set change_pct = pos.get("change_pct", 0) %}
                            {% set action = pos.get("action", "HOLD") %}
                            {% set action_reason = pos.get("action_reason", "") %}
                            <tr 
                                data-ticker="{{ ticker }}" 
                                data-analysis-summary="{{ pos.get('analysis_summary', '')|e }}"
                            >
                                <td><strong>{{ ticker }}</strong></td>
                                <td>{{ holding.symbol }}</td>
                                <td class="editable" data-field="shares">{{ holding.shares }}</td>
                                <td class="editable" data-field="baseline_value_gbp">¬£{{ "%.2f"|format(holding.baseline_value_gbp) }}</td>
                                <td class="{% if current_value and change_gbp >= 0 %}positive{% elif current_value and change_gbp < 0 %}negative{% endif %}">
                                    {% if current_value %}
                                        ¬£{{ "%.2f"|format(current_value) }}
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                <td class="{% if change_gbp >= 0 %}positive{% else %}negative{% endif %}">
                                    {% if current_value %}
                                        {{ "+" if change_gbp >= 0 else "" }}¬£{{ "%.2f"|format(change_gbp) }}
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                <td class="{% if change_pct >= 0 %}positive{% else %}negative{% endif %}">
                                    {% if current_value %}
                                        {{ "+" if change_pct >= 0 else "" }}{{ "%.2f"|format(change_pct) }}%
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                <td>
                                    {% if current_value %}
                                        <span class="action-badge action-{{ action|lower }}" 
                                              title="{{ action_reason or action }}">
                                            {{ action }}
                                        </span>
                                    {% else %}
                                        --
                                    {% endif %}
                                </td>
                                <td>{{ holding.risk_bucket }}</td>
                                <td>
                                    <button class="btn-icon btn-edit" data-ticker="{{ ticker }}" title="Edit">‚úèÔ∏è</button>
                                    <button class="btn-icon btn-delete" data-ticker="{{ ticker }}" title="Delete">üóëÔ∏è</button>
                                </td>
                            </tr>
                            {% endfor %}
                            {% if portfolio_pnl.totals %}
                            <tr class="total-row">
                                <td>
                                    <strong>
                                        TOTAL (Current Baseline, Age: {{ portfolio_pnl.totals.current_baseline_age_days|default(0) }} days)
                                    </strong>
                                </td>
                                <td></td>
                                <td></td>
                                <td><strong>¬£{{ "%.2f"|format(portfolio_pnl.totals.total_baseline_value) }}</strong></td>
                                <td><strong>¬£{{ "%.2f"|format(portfolio_pnl.totals.total_current_value) }}</strong></td>
                                <td class="{% if portfolio_pnl.totals.total_change_gbp >= 0 %}positive{% else %}negative{% endif %}">
                                    <strong>{{ "+" if portfolio_pnl.totals.total_change_gbp >= 0 else "" }}¬£{{ "%.2f"|format(portfolio_pnl.totals.total_change_gbp) }}</strong>
                                </td>
                                <td class="{% if portfolio_pnl.totals.total_change_pct >= 0 %}positive{% else %}negative{% endif %}">
                                    <strong>{{ "+" if portfolio_pnl.totals.total_change_pct >= 0 else "" }}{{ "%.2f"|format(portfolio_pnl.totals.total_change_pct) }}%</strong>
                                </td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            <tr class="total-row original-baseline-row">
                                <td>
                                    <strong>
                                        TOTAL (Original Baseline, Age: {{ portfolio_pnl.totals.original_baseline_age_days|default(0) }} days)
                                    </strong>
                                </td>
                                <td></td>
                                <td></td>
                                <td><strong>¬£{{ "%.2f"|format(portfolio_pnl.totals.original_baseline_total) }}</strong></td>
                                <td><strong>¬£{{ "%.2f"|format(portfolio_pnl.totals.total_current_value) }}</strong></td>
                                <td class="{% if portfolio_pnl.totals.original_pnl_gbp >= 0 %}positive{% else %}negative{% endif %}">
                                    <strong>{{ "+" if portfolio_pnl.totals.original_pnl_gbp >= 0 else "" }}¬£{{ "%.2f"|format(portfolio_pnl.totals.original_pnl_gbp) }}</strong>
                                </td>
                                <td class="{% if portfolio_pnl.totals.original_pnl_pct >= 0 %}positive{% else %}negative{% endif %}">
                                    <strong>{{ "+" if portfolio_pnl.totals.original_pnl_pct >= 0 else "" }}{{ "%.2f"|format(portfolio_pnl.totals.original_pnl_pct) }}%</strong>
                                </td>
                                <td></td>
                                <td></td>
                                <td></td>
                            </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Portfolio Value Charts -->
            <div class="card portfolio-charts">
                <h2>üìà Portfolio Value Trends</h2>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <h3>Since Current Baseline</h3>
                        <canvas id="current-baseline-chart"></canvas>
                    </div>
                    <div class="chart-wrapper">
                        <h3>Since Original Baseline</h3>
                        <canvas id="original-baseline-chart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Buy Recommendations -->
            <div class="card buy-recommendations">
                <div class="card-header">
                    <h2>üí∞ Buy Recommendations</h2>
                    <button id="btn-refresh-buys" class="btn btn-small btn-secondary">Refresh</button>
                </div>
                <div id="buy-recommendations-content">
                    <p class="loading">Loading buy recommendations...</p>
                </div>
            </div>

            <!-- Risk History Chart -->
            <div class="card risk-history">
                <h2>Risk Score History</h2>
                <div class="history-container">
                    <canvas id="history-chart"></canvas>
                    <div class="history-meta" id="risk-history-meta">Loading risk history...</div>
                    <div class="history-table" id="risk-history-table"></div>
                </div>
            </div>

            <!-- Latest Report Preview -->
            {% if latest_report %}
            <div class="card report-preview">
                <h2>Latest Report Preview</h2>
                <div class="report-content">
                    <pre id="report-content">{{ latest_report.content[:1000] }}...</pre>
                    <a href="/reports/{{ latest_report.html_path }}" target="_blank" class="btn btn-small">View Full Report</a>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Edit Holding Modal -->
    <div id="edit-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modal-title">Edit Holding</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="edit-form">
                    <input type="hidden" id="edit-ticker" name="ticker">
                    <div class="form-group">
                        <label for="edit-symbol">Symbol:</label>
                        <input type="text" id="edit-symbol" name="symbol" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-shares">Shares:</label>
                        <input type="number" id="edit-shares" name="shares" step="0.00000001" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-baseline">Baseline Value (¬£):</label>
                        <input type="number" id="edit-baseline" name="baseline_value_gbp" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="edit-type">Type:</label>
                        <input type="text" id="edit-type" name="type" value="equity">
                    </div>
                    <div class="form-group">
                        <label for="edit-risk-bucket">Risk Bucket:</label>
                        <select id="edit-risk-bucket" name="risk_bucket">
                            <option value="low-beta-uk">Low Beta UK</option>
                            <option value="core-ai">Core AI</option>
                            <option value="high-beta-ai">High Beta AI</option>
                            <option value="crypto-beta">Crypto Beta</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Save</button>
                        <button type="button" class="btn btn-secondary" id="btn-cancel">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Add Holding Modal -->
    <div id="add-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Add New Holding</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <form id="add-form">
                    <div class="form-group">
                        <label for="add-ticker">Ticker:</label>
                        <input type="text" id="add-ticker" name="ticker" required>
                    </div>
                    <div class="form-group">
                        <label for="add-symbol">Symbol:</label>
                        <input type="text" id="add-symbol" name="symbol" required>
                    </div>
                    <div class="form-group">
                        <label for="add-shares">Shares:</label>
                        <input type="number" id="add-shares" name="shares" step="0.00000001" required>
                    </div>
                    <div class="form-group">
                        <label for="add-baseline">Baseline Value (¬£):</label>
                        <input type="number" id="add-baseline" name="baseline_value_gbp" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="add-type">Type:</label>
                        <input type="text" id="add-type" name="type" value="equity">
                    </div>
                    <div class="form-group">
                        <label for="add-risk-bucket">Risk Bucket:</label>
                        <select id="add-risk-bucket" name="risk_bucket">
                            <option value="low-beta-uk">Low Beta UK</option>
                            <option value="core-ai">Core AI</option>
                            <option value="high-beta-ai">High Beta AI</option>
                            <option value="crypto-beta">Crypto Beta</option>
                            <option value="unknown">Unknown</option>
                        </select>
                    </div>
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary">Add</button>
                        <button type="button" class="btn btn-secondary" id="btn-cancel-add">Cancel</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Notification Toast -->
    <div id="toast" class="toast"></div>

    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Portfolio baseline values
        const currentBaselineTotal = {{ portfolio_pnl.totals.total_baseline_value|default(0) }};
        const originalBaselineTotal = {{ portfolio_pnl.totals.original_baseline_total|default(0) }};
        const originalBaselineDate = {{ (portfolio.get('original_baseline_date') or portfolio.get('baseline_date') or '')|tojson }};
        const currentBaselineDate = {{ (portfolio.get('current_baseline_date') or portfolio.get('original_baseline_date') or portfolio.get('baseline_date') or '')|tojson }};
        const historyData = {{ history|tojson if history else '[]' }};
        
        // Initialize risk score history chart from evaluation history (one point per date)
        (async function initRiskHistoryChart() {
            const metaEl = document.getElementById('risk-history-meta');
            const tableEl = document.getElementById('risk-history-table');
            const canvas = document.getElementById('history-chart');
            if (!canvas) return;

            try {
                const resp = await fetch(`/api/risk-history?_t=${Date.now()}`);
                const data = await resp.json();

                if (!Array.isArray(data) || data.length === 0) {
                    if (metaEl) metaEl.textContent = 'No evaluation history yet.';
                    return;
                }

                // Oldest -> newest for plotting
                const chronological = [...data].sort((a, b) => String(a.date).localeCompare(String(b.date)));
                const labels = chronological.map(d => d.date);
                const scores = chronological.map(d => d.risk_score);

                const last = chronological[chronological.length - 1];
                const minScore = Math.min(...scores);
                const maxScore = Math.max(...scores);
                if (metaEl) metaEl.textContent = `Evaluations through: ${last.date} (${chronological.length} pts) ‚Ä¢ Latest score: ${last.risk_score} ‚Ä¢ Range: ${minScore}‚Äì${maxScore}`;

                // Also render a simple table (last 10) so low-but-nonzero scores are obvious at a glance.
                if (tableEl) {
                    const lastN = chronological.slice(-10).reverse();
                    tableEl.innerHTML = lastN.map(r => `<div class="history-row"><span class="history-date">${r.date}</span><span class="history-score">${r.risk_score}</span></div>`).join('');
                }

                const ctx = canvas.getContext('2d');
                const yMax = maxScore <= 10 ? 10 : 100;
            new Chart(ctx, {
                type: 'line',
                data: {
                        labels,
                    datasets: [{
                            label: 'Risk-off Score',
                            data: scores,
                        borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.12)',
                            tension: 0.1,
                            fill: true,
                            pointRadius: 3,
                            pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                        maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                                max: yMax,
                                ticks: {
                                    stepSize: yMax <= 10 ? 1 : undefined
                                }
                        }
                    }
                }
            });
            } catch (e) {
                if (metaEl) metaEl.textContent = 'Error loading evaluation history.';
            }
        })();
        
        // Initialize portfolio value charts
        if (historyData.length > 0 && currentBaselineTotal > 0) {
            // Filter out bad data (values that are clearly wrong, e.g., > 1000)
            const validHistory = historyData.filter(h => h.portfolio_value && h.portfolio_value < 1000);
            
            if (validHistory.length === 0) {
                console.warn('No valid history data for charts');
            } else {
            
            // Sort history by date (oldest first)
            const sortedHistory = [...validHistory].sort((a, b) => a.date.localeCompare(b.date));
            
            // Start each chart from its configured baseline date.
            // If the configured date is missing/blank, fall back to earliest available history point.
            const currentBaselineStartDate = (currentBaselineDate && String(currentBaselineDate).length)
                ? String(currentBaselineDate)
                : sortedHistory[0].date;
            const originalBaselineStartDate = (originalBaselineDate && String(originalBaselineDate).length)
                ? String(originalBaselineDate)
                : sortedHistory[0].date;
            
            // Filter data for each chart based on start dates
            const originalBaselineData = sortedHistory.filter(h => h.date >= originalBaselineStartDate);
            const currentBaselineData = sortedHistory.filter(h => h.date >= currentBaselineStartDate);
            
            // Current Baseline Chart - shows data from when current baseline was established
            if (currentBaselineData.length > 0) {
                const currentDates = currentBaselineData.map(h => h.date);
                const currentValues = currentBaselineData.map(h => h.portfolio_value);
                
                const currentCtx = document.getElementById('current-baseline-chart').getContext('2d');
                new Chart(currentCtx, {
                    type: 'line',
                    data: {
                        labels: currentDates,
                        datasets: [{
                            label: 'Portfolio Value',
                            data: currentValues,
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1,
                            fill: true
                        }, {
                            label: 'Current Baseline',
                            data: Array(currentDates.length).fill(currentBaselineTotal),
                            borderColor: 'rgb(128, 128, 128)',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += '¬£' + context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Value (¬£)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '¬£' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            
            // Original Baseline Chart - shows data from original baseline date
            if (originalBaselineTotal > 0 && originalBaselineData.length > 0) {
                const originalDates = originalBaselineData.map(h => h.date);
                const originalValues = originalBaselineData.map(h => h.portfolio_value);
                
                const originalCtx = document.getElementById('original-baseline-chart').getContext('2d');
                new Chart(originalCtx, {
                    type: 'line',
                    data: {
                        labels: originalDates,
                        datasets: [{
                            label: 'Portfolio Value',
                            data: originalValues,
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            fill: true
                        }, {
                            label: 'Original Baseline',
                            data: Array(originalDates.length).fill(originalBaselineTotal),
                            borderColor: 'rgb(128, 128, 128)',
                            borderDash: [5, 5],
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: false
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'top'
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += '¬£' + context.parsed.y.toFixed(2);
                                        }
                                        return label;
                                    }
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Date'
                                }
                            },
                            y: {
                                display: true,
                                title: {
                                    display: true,
                                    text: 'Value (¬£)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return '¬£' + value.toFixed(0);
                                    }
                                }
                            }
                        }
                    }
                });
            }
            }
        }
    </script>
</body>
</html>

