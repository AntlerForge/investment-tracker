#!/bin/bash

# Get the directory where this app bundle is located
APP_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
PROJECT_DIR="$HOME/Library/Mobile Documents/com~apple~CloudDocs/Projects/investment/risk-portfolio-system"

# Check if project exists in expected location
if [ ! -d "$PROJECT_DIR" ]; then
    osascript -e 'display dialog "Project directory not found at expected location. Please update the script path." buttons {"OK"} default button "OK" with icon stop'
    exit 1
fi

cd "$PROJECT_DIR"

# Configuration
PORT=5001
URL="http://localhost:${PORT}"

# Function to check if server is running
check_server() {
    lsof -ti:${PORT} > /dev/null 2>&1
}

# Function to start the server
start_server() {
    # Activate virtual environment if it exists
    if [ -d ".venv" ]; then
        source .venv/bin/activate
    elif [ -d "venv" ]; then
        source venv/bin/activate
    else
        osascript -e 'display dialog "Virtual environment not found! Please run setup first." buttons {"OK"} default button "OK" with icon stop'
        exit 1
    fi
    
    # Check if Flask is installed
    if ! python -c "import flask" 2>/dev/null; then
        pip install -q flask
    fi
    
    # Start Flask server in background
    python app.py > /tmp/risk-portfolio-dashboard.log 2>&1 &
    
    # Wait for server to start (max 10 seconds)
    for i in {1..10}; do
        sleep 1
        if check_server; then
            return 0
        fi
    done
    
    osascript -e 'display dialog "Server failed to start. Check logs for errors." buttons {"OK"} default button "OK" with icon stop'
    return 1
}

# Check if server is already running
if ! check_server; then
    start_server
fi

# Open browser
sleep 1
open "${URL}"

